Bootstrap: docker
From: nvidia/cuda:12.1.1-cudnn8-devel-ubuntu22.04

%files
    pyproject.toml /transcriptomic-fms/
    README.md /transcriptomic-fms/
    transcriptomic_fms /transcriptomic-fms/transcriptomic_fms

%labels
    Author "Ahmed Sallam"
    Version "0.1.0"
    Description "scConcept Container (PyTorch + FlashAttention + CUDA Support)"

%post
    # 1. System Dependency Installation
    export DEBIAN_FRONTEND=noninteractive
    apt-get update && apt-get install -y \
        python3 \
        python3-pip \
        python3-dev \
        git \
        build-essential \
        wget \
        pkg-config \
        tzdata \
        curl

    ln -s /usr/bin/python3 /usr/bin/python
    pip3 install --upgrade pip setuptools wheel packaging

    # 2. Patch pyproject.toml to allow Python 3.10 inside container
    sed -i 's/requires-python = ">=3.11"/requires-python = ">=3.10"/g' /transcriptomic-fms/pyproject.toml
    sed -i "s/requires-python = '>=3.11'/requires-python = '>=3.10'/g" /transcriptomic-fms/pyproject.toml

    # 3. Install PyTorch with CUDA 12.1 support
    # This matches the CUDA 12.1 base image and ensures compatibility with flash-attn 2.7.*
    pip install torch torchvision torchaudio --index-url https://download.pytorch.org/whl/cu121

    # 4. Core scientific stack
    pip install "numpy" "pandas" "scanpy" "anndata" "scipy" "scikit-learn"
    pip install "requests" "tqdm" "h5py" "tables"

    # 5. Install FlashAttention (required by scConcept)
    # Use --no-build-isolation as recommended by scConcept docs to ensure the build
    # sees the correct torch/CUDA toolchain from the container image.
    pip install "flash-attn==2.7.*" --no-build-isolation

    # 6. Install scConcept and lamin_dataloader from GitHub without pulling extra deps
    # Dependencies (torch, flash-attn, numpy, etc.) are already pinned above.
    pip install --no-deps git+https://github.com/theislab/lamin_dataloader.git
    pip install --no-deps git+https://github.com/theislab/scConcept.git@main

    # 7. Project tooling & utilities
    pip install "ipython" "jupyterlab" "matplotlib" "notebook" "python-dotenv" "ruff"

    # 8. Install our package (editable, no dependency resolution)
    cd /transcriptomic-fms
    pip install --no-deps --ignore-requires-python -e .

    # 9. Create standard directories
    mkdir -p /transcriptomic-fms/data
    mkdir -p /transcriptomic-fms/output
    mkdir -p /transcriptomic-fms/models

    # 10. Final Verification
    echo "=== VERSION CHECK ==="
    pip list | grep -E "torch|flash-attn|concept|lamin|numpy|scanpy"

%environment
    export LC_ALL=C.UTF-8
    export LANG=C.UTF-8
    export DEBIAN_FRONTEND=noninteractive

    export CUDA_HOME=/usr/local/cuda
    export LD_LIBRARY_PATH=$LD_LIBRARY_PATH:/usr/local/cuda/lib64
    export PYTHONPATH="/transcriptomic-fms:$PYTHONPATH"
    export PYTHONUNBUFFERED=1
    export PYTHONNOUSERSITE=1

    export REQUESTS_CA_BUNDLE=/etc/ssl/certs/ca-certificates.crt
    export SSL_CERT_FILE=/etc/ssl/certs/ca-certificates.crt
    export CURL_CA_BUNDLE=/etc/ssl/certs/ca-certificates.crt

%runscript
    exec python -m transcriptomic_fms.cli.main "$@"

