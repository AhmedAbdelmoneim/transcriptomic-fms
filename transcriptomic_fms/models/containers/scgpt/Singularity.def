Bootstrap: docker
From: pytorch/pytorch:1.13.0-cuda11.6-cudnn8-devel

%files
    pyproject.toml /transcriptomic-fms/
    README.md /transcriptomic-fms/
    transcriptomic_fms /transcriptomic-fms/transcriptomic_fms

%post
    # Set environment variable to prevent interactive prompts
    export DEBIAN_FRONTEND=noninteractive

    # Update the package list and install packages
    apt-get update -y
    apt-get install -y git r-base tzdata

    # Install Python packages using pip (following proven working method)
    pip install packaging
    pip install scgpt "flash-attn<1.0.5"
    pip install markupsafe==2.0.1
    pip install wandb
    pip uninstall torch -y
    pip install torch==1.13.0+cu116 -f https://download.pytorch.org/whl/torch_stable.html
    pip install pyro-ppl==1.8.6

    # Install additional dependencies for our package
    pip install "pandas" "scanpy" "gdown" "python-louvain" "umap-learn<0.5.7"
    pip install "ipython" "jupyterlab" "matplotlib" "notebook" "python-dotenv" "ruff" "scikit-learn"

    # Set working directory and install our package
    # Use --no-deps to prevent pip from upgrading any packages we've carefully pinned
    cd /transcriptomic-fms
    pip install --no-deps -e .

    # Create data and output directories
    mkdir -p /transcriptomic-fms/data
    mkdir -p /transcriptomic-fms/output
    mkdir -p /transcriptomic-fms/models

%environment
    export DEBIAN_FRONTEND=noninteractive
    export PATH=/opt/conda/bin:$PATH
    export PYTHONPATH="/transcriptomic-fms:$PYTHONPATH"
    export PYTHONUNBUFFERED=1
    export PYTHONNOUSERSITE=1
    # Set SSL certificate paths for gdown
    export REQUESTS_CA_BUNDLE=/etc/ssl/certs/ca-certificates.crt
    export SSL_CERT_FILE=/etc/ssl/certs/ca-certificates.crt
    export CURL_CA_BUNDLE=/etc/ssl/certs/ca-certificates.crt

%runscript
    # Default command
    exec python -m transcriptomic_fms.cli.main "$@"

%labels
    Author "Ahmed Sallam"
    Version "0.1.0"
    Description "Transcriptomic Foundation Models - scGPT container with CUDA support"
