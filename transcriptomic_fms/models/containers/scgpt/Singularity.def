Bootstrap: docker
From: nvidia/cuda:12.1.0-devel-ubuntu22.04

%files
    pyproject.toml /transcriptomic-fms/
    README.md /transcriptomic-fms/
    transcriptomic_fms /transcriptomic-fms/transcriptomic_fms

%post
    # Suppress debconf and update-alternatives warnings
    export DEBIAN_FRONTEND=noninteractive
    export UCF_FORCE_CONFFNEW=1
    
    # Set CUDA and uv paths (set once at the beginning)
    export PATH="/usr/local/cuda/bin:$PATH"
    export LD_LIBRARY_PATH="/usr/local/cuda/lib64:$LD_LIBRARY_PATH"
    
    # Update package lists and install system dependencies
    # Retry apt-get update in case of transient mirror sync issues
    for i in 1 2 3; do
        if apt-get update -qq; then
            break
        else
            if [ $i -eq 3 ]; then
                echo "ERROR: apt-get update failed after 3 attempts"
                exit 1
            fi
            echo "apt-get update failed, retrying in 5 seconds... (attempt $i/3)"
            sleep 5
        fi
    done
    apt-get install -y -qq --no-install-recommends \
        build-essential \
        git \
        curl \
        ca-certificates \
        python3.11 \
        python3.11-dev \
        python3-pip \
        python3-venv \
        libhdf5-dev \
        libhdf5-103 \
        libpng-dev \
        libfreetype6-dev \
        libblas-dev \
        liblapack-dev \
        pkg-config \
        openssl
    
    # Update CA certificates for gdown
    update-ca-certificates || true
    
    # Create symlink for python
    ln -sf /usr/bin/python3.11 /usr/bin/python || true
    ln -sf /usr/bin/python3.11 /usr/bin/python3 || true
    
    # Clean up apt lists to reduce image size
    rm -rf /var/lib/apt/lists/*
    
    # Update library cache so system libraries can be found
    ldconfig
    
    # Install uv and add to PATH
    curl -LsSf https://astral.sh/uv/install.sh | sh
    export PATH="/root/.local/bin:$PATH"

    # Set working directory
    cd /transcriptomic-fms

    # Test network connection to PyTorch download servers
    echo "Testing network connection to PyTorch download servers..."
    if curl -s -o /dev/null -w "Connected in %{time_connect}s, total: %{time_total}s\n" \
        --max-time 10 \
        https://download.pytorch.org/whl/cu121/ 2>/dev/null; then
        echo "Network connectivity OK"
    else
        echo "Warning: Connection test failed - network may be slow"
        echo "If PyTorch installation hangs, network speed may be the issue."
    fi

    # Install PyTorch with CUDA support first (before other dependencies)
    echo "Installing PyTorch with CUDA support (downloading wheel, should be fast)..."
    /root/.local/bin/uv pip install --system \
        --preview-features extra-build-dependencies \
        --index-url https://download.pytorch.org/whl/cu121 \
        "torch>=2.0.0,<2.3.0" || {
        echo "ERROR: PyTorch installation failed!"
        exit 1
    }
    echo "PyTorch installed successfully"

    # Following PROVEN working installation method from scGPT community
    # Key: numpy<1.24 FIRST (even stricter than <2.0)
    echo "Installing numpy<1.24 (proven working version for scGPT)..."
    /root/.local/bin/uv pip install --system \
        --preview-features extra-build-dependencies \
        --upgrade "numpy<1.24"
    
    # Verify numpy version (simple check: major.minor must be < 1.24)
    python -c "import numpy; v = numpy.__version__; parts = v.split('.'); major, minor = int(parts[0]), int(parts[1]); assert major < 1 or (major == 1 and minor < 24), f'ERROR: numpy {v} is >= 1.24'; print(f'✓ numpy {v} installed (< 1.24)')" || exit 1
    
    # Install packaging first (required for flash-attn build)
    echo "Installing packaging (required for flash-attn build)..."
    /root/.local/bin/uv pip install --system \
        --preview-features extra-build-dependencies \
        "packaging" || {
        echo "ERROR: packaging installation failed!"
        exit 1
    }
    
    # Install flash-attn with --no-build-isolation (as per working example)
    echo "Installing flash-attn with --no-build-isolation (proven method)..."
    /root/.local/bin/uv pip install --system \
        --preview-features extra-build-dependencies \
        --no-build-isolation \
        "flash-attn==1.0.6" || {
        echo "ERROR: flash-attn installation failed! This is required."
        exit 1
    }
    
    # Verify flash-attn installed
    python -c "import flash_attn; print('✓ flash-attn installed')" || {
        echo "ERROR: flash-attn import failed!"
        exit 1
    }
    
    # Install scGPT with --no-deps FIRST (as per working example)
    echo "Installing scGPT with --no-deps (proven method)..."
    /root/.local/bin/uv pip install --system \
        --preview-features extra-build-dependencies \
        --no-deps \
        "scgpt" || {
        echo "ERROR: scGPT installation failed!"
        exit 1
    }
    
    # Install scGPT dependencies with specific versions (as per working example)
    echo "Installing scGPT dependencies (proven working versions)..."
    /root/.local/bin/uv pip install --system \
        --preview-features extra-build-dependencies \
        "pandas" "scanpy" "wandb" "gdown" "python-louvain" "umap-learn<0.5.7" || {
        echo "ERROR: scGPT dependencies installation failed!"
        exit 1
    }
    
    # Install base package dependencies (excluding numpy - already installed)
    echo "Installing base package dependencies..."
    /root/.local/bin/uv pip install --system \
        --preview-features extra-build-dependencies \
        "ipython" "jupyterlab" "matplotlib" "notebook" "python-dotenv" "ruff" "scikit-learn" || {
        echo "ERROR: Base dependencies installation failed!"
        exit 1
    }
    
    # Install the package itself (no deps to avoid numpy upgrade)
    echo "Installing package in editable mode (no deps)..."
    /root/.local/bin/uv pip install --system \
        --preview-features extra-build-dependencies \
        --no-deps \
        -e . || {
        echo "ERROR: Package installation failed!"
        exit 1
    }
    
    # CRITICAL: Lock numpy<1.24 one final time
    echo "Final numpy lock (numpy<1.24)..."
    /root/.local/bin/uv pip install --system \
        --preview-features extra-build-dependencies \
        --force-reinstall \
        "numpy<1.24" || {
        echo "ERROR: Failed to lock numpy<1.24!"
        exit 1
    }
    
    # Final verification - BUILD FAILS if numpy >= 1.24
    python << 'PYEOF'
import numpy
v = numpy.__version__
parts = v.split('.')
major = int(parts[0])
minor = int(parts[1]) if len(parts) > 1 else 0
if major > 1 or (major == 1 and minor >= 24):
    print(f"❌ CRITICAL ERROR: numpy {v} is >= 1.24")
    print("Forcing downgrade to numpy 1.23.5...")
    import subprocess
    import sys
    result = subprocess.run([
        "/root/.local/bin/uv", "pip", "install", "--system",
        "--preview-features", "extra-build-dependencies",
        "--force-reinstall",
        "numpy==1.23.5"
    ], capture_output=True, text=True)
    if result.returncode != 0:
        print("EMERGENCY FIX FAILED!")
        print(result.stderr)
        sys.exit(1)
    import importlib
    importlib.reload(numpy)
    v2 = numpy.__version__
    parts2 = v2.split('.')
    major2 = int(parts2[0])
    minor2 = int(parts2[1]) if len(parts2) > 1 else 0
    if major2 > 1 or (major2 == 1 and minor2 >= 24):
        print(f"STILL FAILED: numpy {v2} is >= 1.24")
        sys.exit(1)
    print(f"✓ Emergency fix: numpy {v2}")
else:
    print(f"✓ FINAL: numpy {v} (< 1.24 - OK)")
PYEOF

    if [ $? -ne 0 ]; then
        echo "CRITICAL BUILD FAILURE: NumPy must be < 1.24 for scGPT"
        exit 1
    fi
    
    # Rebuild h5py from source to ensure it links against the installed HDF5 version
    # h5py wheels may be built against a different HDF5 version than what's in the container
    echo "Rebuilding h5py from source to match system HDF5 libraries..."
    
    # Ubuntu provides libhdf5_serial.so but h5py looks for libhdf5.so
    # Create symlinks so h5py can find the libraries
    cd /lib/x86_64-linux-gnu
    if [ -f "libhdf5_serial.so.103" ] && [ ! -f "libhdf5.so.103" ]; then
        ln -sf libhdf5_serial.so.103 libhdf5.so.103
        ln -sf libhdf5_serial.so libhdf5.so
    fi
    if [ -f "libhdf5_serial_hl.so.100" ] && [ ! -f "libhdf5_hl.so.100" ]; then
        ln -sf libhdf5_serial_hl.so.100 libhdf5_hl.so.100
        ln -sf libhdf5_serial_hl.so libhdf5_hl.so
    fi
    cd /transcriptomic-fms
    
    # Update library cache
    ldconfig
    
    # Set HDF5 environment for h5py build - use ONLY one method (h5py doesn't allow multiple)
    # Option 1: Use HDF5_DIR prefix (simplest)
    # h5py will look in /usr/include and /usr/lib for headers/libs
    # But serial HDF5 is in /usr/include/hdf5/serial, so we need to point there
    # Option 2: Use HDF5_INCLUDEDIR and HDF5_LIBDIR (without HDF5_DIR)
    # Option 3: Use pkg-config (if available)
    
    # Try using just HDF5_DIR first, pointing to where serial HDF5 is
    # But h5py expects standard layout, so let's use include/lib dirs instead
    unset HDF5_DIR || true
    export HDF5_INCLUDEDIR=/usr/include/hdf5/serial
    export HDF5_LIBDIR=/usr/lib/x86_64-linux-gnu
    # Don't set PKG_CONFIG_PATH if we're using include/lib dirs
    
    /root/.local/bin/uv pip install --system \
        --preview-features extra-build-dependencies \
        --force-reinstall --no-binary h5py h5py || {
        echo "ERROR: h5py rebuild failed! This is required for HDF5 compatibility."
        echo "Checking HDF5 installation..."
        ldconfig -p | grep hdf5 || echo "No HDF5 libraries found in cache"
        find /usr/lib -name "*libhdf5*" 2>/dev/null | head -5 || echo "No HDF5 libraries found"
        exit 1
    }
    
    # Verify h5py can import
    echo "Verifying h5py installation..."
    python -c "import h5py; print(f'h5py version: {h5py.__version__}')" || {
        echo "ERROR: h5py import failed after rebuild!"
        exit 1
    }
    
    # Verify numpy version matches scGPT requirements
    echo "Verifying numpy version..."
    python -c "import numpy; print(f'numpy version: {numpy.__version__}')" || echo "WARNING: Could not verify numpy version"

    # Verify torch is still the CUDA version
    /root/.local/bin/uv pip install --system \
        --preview-features extra-build-dependencies \
        --index-url https://download.pytorch.org/whl/cu121 \
        --upgrade-package torch "torch>=2.0.0,<2.3.0" || true

    # Create data and output directories
    mkdir -p /transcriptomic-fms/data
    mkdir -p /transcriptomic-fms/output
    mkdir -p /transcriptomic-fms/models

%environment
    export PATH="/root/.local/bin:/usr/local/cuda/bin:$PATH"
    export LD_LIBRARY_PATH="/usr/local/cuda/lib64:/usr/lib/x86_64-linux-gnu:/usr/lib:$LD_LIBRARY_PATH"
    export PYTHONPATH="/transcriptomic-fms:$PYTHONPATH"
    export PYTHONUNBUFFERED=1
    export PYTHONNOUSERSITE=1
    export HDF5_DIR=/usr
    # Set SSL certificate paths for gdown (Ubuntu/Debian)
    export REQUESTS_CA_BUNDLE=/etc/ssl/certs/ca-certificates.crt
    export SSL_CERT_FILE=/etc/ssl/certs/ca-certificates.crt
    export CURL_CA_BUNDLE=/etc/ssl/certs/ca-certificates.crt

%runscript
    # Default command
    exec python -m transcriptomic_fms.cli.main "$@"

%labels
    Author "Ahmed Sallam"
    Version "0.1.0"
    Description "Transcriptomic Foundation Models - scGPT container with CUDA support"
